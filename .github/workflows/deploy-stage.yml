name: DEPLOY-TO-STAGE
run-name: Continuous Deployment for Stage Environment

on:
  # Runs on pushes targeting the default branch
  repository_dispatch:
    types: [deploy]

jobs: 

  # Continuous delivery workflow in 'ss-pipeline' repo
  continuous-delivery:
    name: CD
    concurrency:
      group: ${{ github.workflow }}
      cancel-in-progress: false  
    uses: dr3dr3/ss-pipeline/.github/workflows/continuous-delivery.yml@main
    with: 
      target-deploy: 'stg'
    permissions:
      contents: read
      pages: write
      id-token: write
    secrets: inherit

  # Dispatch to Deploy to Canary Environment
  dispatch-can:
    name: Dispatch Canary
    needs: [continuous-delivery]
    uses: dr3dr3/ss-pipeline/.github/workflows/continuous-deployment.yml@main
    with:
      target-deploy: 'can'
    secrets: inherit